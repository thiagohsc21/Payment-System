# API Reference

This document details the RESTful API endpoints provided by the Payment Orchestrator.

**Base URL:** `http://localhost:8080/api/v1`

## Overview

The API follows standard REST conventions:
* **JSON** is used for all request and response bodies.
* **Standard HTTP Status Codes** are used to indicate success or failure.
* **Dates** are returned in ISO 8601 format (`YYYY-MM-DDThh:mm:ss`).

---

## 1. Create Transaction

Initiates a new payment transaction. This endpoint is **asynchronous**: it validates the request, persists the intention, and returns immediately with a `PENDING` status while the processing happens in the background.

* **URL:** `/payments`
* **Method:** `POST`
* **Auth:** None (Public for MVP)

### Request Body

| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `amount` | `Decimal` | Yes | The transaction amount (e.g., `100.50`). Must be positive. |
| `currency` | `String` | Yes | 3-letter ISO currency code (e.g., `BRL`, `USD`). |
| `card_token` | `String` | Yes | Token representing the credit card (from Stripe). **Never send raw card numbers.** |
| `description`| `String` | No | A brief description of the purchase. |
| `idempotency_key` | `String` | Yes | Unique key generated by the client to prevent double-charging on retries. |

**Example JSON:**

```json
{
  "amount": 150.00,
  "currency": "BRL",
  "card_token": "tok_visa_credit_test",
  "description": "Premium Subscription",
  "idempotency_key": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
}
```

### Success Response

* **Code:** `201 Created`
* **Content:**

```json
{
  "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "PENDING",
  "message": "Transaction created and queued for processing."
}
```

### Error Responses

* **Code:** `400 Bad Request`
    * **Reason:** Missing mandatory fields or invalid format (e.g., negative amount).
* **Content:**

```json
{
  "timestamp": "2025-11-14T14:30:05",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed",
  "errors": [
    "amount: must be greater than 0",
    "currency: must not be blank"
  ],
  "path": "/api/v1/payments"
}
```

* **Code:** `422 Unprocessable Entity`
    * **Reason:** Business rule violation (e.g., duplicate Idempotency Key with different payload).
* **Content:**

```json
{
  "timestamp": "2025-11-14T14:31:00",
  "status": 422,
  "error": "Unprocessable Entity",
  "message": "Idempotency key 'unique-key-123' already used for a different request.",
  "path": "/api/v1/payments"
}
```


## 2. Get Transaction Status

Retrieves the current details and status of a specific transaction. Since processing is asynchronous, clients should poll this endpoint or listen to webhooks (future scope) to know when the status changes from `PENDING` to `APPROVED` or `DENIED`.

* **URL:** `/payments/{id}`
* **Method:** `GET`

### URL Parameters

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `id` | `UUID` | The unique ID of the transaction returned in the creation step. |

### Success Response

* **Code:** `200 OK`
* **Content:**

```json
{
  "transaction_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "APPROVED",
  "amount": 150.00,
  "currency": "BRL",
  "description": "Premium Subscription",
  "created_at": "2025-11-14T14:30:00"
}
```

### Error Response

* **Code:** `404 Not Found`
* **Reason: **

```json
{
    "timestamp": "2025-11-14T14:35:00",
    "status": 404,
    "error": "Not Found",
    "message": "Transaction not found with ID: 550e8400-e29b-41d4-a716-446655440000",
    "path": "/api/v1/payments/550e8400-e29b-41d4-a716-446655440000"
}
```